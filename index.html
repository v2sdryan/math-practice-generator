<!doctype html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>數學 MC 練習器</title>
    <style>
      body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; background:#0b1020; color:#e5e7eb; }
      .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
      .card { background:#121933; border:1px solid #243050; border-radius:14px; padding:16px; margin-bottom:14px; }
      h1 { margin:0 0 8px; }
      .muted { color:#9ca3af; font-size:14px; }
      input, button, select { border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; padding:10px; }
      button { cursor:pointer; border:none; background:#22c55e; color:#052e16; font-weight:700; }
      button.secondary { background:#334155; color:#e5e7eb; }
      .q { border:1px solid #334155; border-radius:12px; padding:12px; margin:10px 0; background:#0f172a; }
      .q h3 { margin:0 0 10px; font-size:17px; }
      .opt { display:flex; align-items:flex-start; gap:10px; margin:8px 0; }
      .opt input { width:auto; margin-top:2px; }
      .opt .opt-text { display:block; white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; font-size:15px; }
      .controls { display:grid; grid-template-columns: 1.2fr .8fr 1fr auto auto auto; gap:10px; align-items:center; }
      .controls input,.controls select { width:100%; min-width:90px; }
      .hidden-after-generate { display:block; }
      .show-after-generate { display:none; }
      .collapsed .hidden-after-generate { display:none !important; }
      .collapsed .show-after-generate { display:inline-block; }
      .collapsed .controls { grid-template-columns: 1fr 1fr 1fr; }
      @media (max-width: 700px) {
        .controls { grid-template-columns: 1fr; }
        .controls .full { grid-column: 1 / -1; }
        .controls select,
        .controls input,
        .controls button { width: 100%; min-height: 44px; }
        button { padding:10px 12px; font-size:15px; }
      }
      .result { margin-top:8px; padding:8px; border-radius:8px; font-size:14px; white-space:pre-wrap; }
      .ok { background:#052e16; color:#86efac; }
      .bad { background:#3f1d1d; color:#fca5a5; }
      .hide { display:none; }
      .sticky { position: sticky; top: 0; z-index: 10; }
      .summary { font-weight:700; }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card sticky" id="controlCard">
        <h1>同類題練習（MC）</h1>
        <p class="muted hidden-after-generate">支援兩種題型，同樣可生成 1-100 題、多項選擇作答、交卷批改，答錯會顯示計算方法。</p>
        <div class="controls">
          <select id="topic" class="hidden-after-generate" aria-label="題型選擇">
            <option value="factor">平方差因式分解：a² - (bm+cn)²</option>
            <option value="quadratic-k">二次方程與參數： (x-pk)² = qk²</option>
            <option value="power-scale">指數題：次方等比例縮放法</option>
          </select>
          <input id="count" class="hidden-after-generate" type="number" min="1" max="100" value="10" aria-label="題數（1-100）" />
          <select id="methodMode" class="hidden-after-generate" aria-label="解題模式">
            <option value="substitute" selected>解題模式：代入選項法</option>
            <option value="algebra">解題模式：代數技巧</option>
          </select>
          <button id="genBtn" class="hidden-after-generate">生成題目</button>
          <button id="submitBtn" class="secondary">交卷批改</button>
          <button id="resetBtn" class="secondary">清除結果</button>
          <button id="backBtn" class="secondary show-after-generate">返回開始版面</button>
          <div class="muted full hidden-after-generate">題數（1-100）</div>
        </div>
        <p id="summary" class="summary"></p>
      </section>

      <section id="questions" class="card">
        <p class="muted">請先按「生成題目」。</p>
      </section>
    </main>

    <script>
      const $controlCard = document.getElementById('controlCard');
      const $topic = document.getElementById('topic');
      const $count = document.getElementById('count');
      const $methodMode = document.getElementById('methodMode');
      const $genBtn = document.getElementById('genBtn');
      const $submitBtn = document.getElementById('submitBtn');
      const $resetBtn = document.getElementById('resetBtn');
      const $backBtn = document.getElementById('backBtn');
      const $questions = document.getElementById('questions');
      const $summary = document.getElementById('summary');

      let quiz = [];

      function randint(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
      function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
      function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function buildFactorQuestion(i) {
        const a = randint(4, 18);
        const b = randint(2, 9);
        const c = randint(2, 9);
        const expr = `${a*a} - (${b}m + ${c}n)<sup>2</sup>`;
        const exprPlain = `${a*a} - (${b}m + ${c}n)^2`;

        const originalAt11 = a*a - (b + c) * (b + c);
        const options = shuffle([
          { text: `(${a} + ${b}m + ${c}n)(${a} - ${b}m - ${c}n)`, ok: true, valAt11: (a + b + c) * (a - b - c) },
          { text: `(${a} + ${b}m + ${c}n)(${a} - ${b}m + ${c}n)`, ok: false, valAt11: (a + b + c) * (a - b + c) },
          { text: `(${a} + ${b}m - ${c}n)(${a} - ${b}m - ${c}n)`, ok: false, valAt11: (a + b - c) * (a - b - c) },
          { text: `(${a} + ${b}m - ${c}n)(${a} - ${b}m + ${c}n)`, ok: false, valAt11: (a + b - c) * (a - b + c) }
        ]).map((o, idx) => ({ ...o, label: 'ABCD'[idx] }));

        const algebraMethod = `【代數技巧】設 A=${a}，B=${b}m+${c}n。\n原式 = A²-B²。\n用恆等式 A²-B²=(A+B)(A-B)，\n得 (${a}+${b}m+${c}n)(${a}-${b}m-${c}n)。`;
        const substituteLines = options.map(o => `${o.label}: 代 m=1,n=1，左式值 ${o.valAt11}${o.valAt11 === originalAt11 ? ' = 原式值' : ' ≠ 原式值'}`);
        const substituteMethod = `【代入選項法】先代 m=1,n=1。\n原式 ${exprPlain} = ${originalAt11}。\n${substituteLines.join('\n')}\n只有與原式值相同的選項正確。`;

        return { id: i, stem: `因式分解：${expr}`, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod };
      }

      function buildQuadraticKQuestion(i) {
        const p = randint(2, 6);
        const q = pick([1, 4, 9, 16]);
        const s = Math.sqrt(q);
        const r1 = p + s;
        const r2 = p - s;

        const stem = `設 k 為常數，解方程：(x - ${p}k)<sup>2</sup> = ${q}k<sup>2</sup>。`;

        const options = shuffle([
          { text: `x = ${r1}k`, ok: false, roots: [r1] },
          { text: `x = ${r2}k`, ok: false, roots: [r2] },
          { text: `x = ${r1}k 或 x = ${r2}k`, ok: true, roots: [r1, r2] },
          { text: `x = -${r1}k 或 x = ${r2}k`, ok: false, roots: [-r1, r2] }
        ]).map((o, idx) => ({ ...o, label: 'ABCD'[idx] }));

        const algebraMethod = `【代數技巧】\n(x-${p}k)²=${q}k² ⇒ x-${p}k=±${s}k\n所以 x=(${p}±${s})k，即 x=${r1}k 或 x=${r2}k。`;
        const subLines = options.map(o => {
          const check = o.roots.map(v => `(x=${v}k): (${v}-${p})² ${((v-p)*(v-p)===q)?'=':'≠'} ${q}`).join('； ');
          return `${o.label}: ${check}`;
        });
        const substituteMethod = `【代入選項法】先令 k=1，方程變成 (x-${p})²=${q}。\n${subLines.join('\n')}\n同時符合方程的根組合為正確選項。`;

        return { id: i, stem, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod };
      }

      function buildPowerScaleQuestion(i) {
        const pack = pick([
          { a: 8, b: 5, base: 10, pa: 3, pb: 1 },
          { a: 4, b: 25, base: 10, pa: 1, pb: 2 },
          { a: 8, b: 125, base: 10, pa: 3, pb: 3 },
          { a: 16, b: 25, base: 10, pa: 4, pb: 2 }
        ]);

        const t = randint(8, 60);
        const z = randint(1, 6);
        const A = pack.pb * t * z;
        const B = pack.pa * t * z;

        const k = pack.pa * A; // = pack.pb * B
        const stem = `${pack.a}<sup>${A}</sup> · ${pack.b}<sup>${B}</sup> =`;

        const options = shuffle([
          { text: `${pack.base}<sup>${k}</sup>`, ok: true, exp: k },
          { text: `${pack.base}<sup>${k + t}</sup>`, ok: false, exp: k + t },
          { text: `${pack.a * pack.b}<sup>${Math.max(1, Math.floor(k / 2))}</sup>`, ok: false, exp: null },
          { text: `${pack.base}<sup>${Math.max(1, k - t)}</sup>`, ok: false, exp: Math.max(1, k - t) }
        ]).map((o, idx) => ({ ...o, label: 'ABCD'[idx] }));

        const s = t;
        const scaledA = A / s;
        const scaledB = B / s;
        const targetScaled = k / s;
        const compareLines = options.map(o => {
          if (o.exp == null) return `${o.label}: 不是同底 ${pack.base} 的標準形式，先排除。`;
          return `${o.label}: ${pack.base}<sup>${o.exp}</sup> → 縮放後 ${pack.base}<sup>${(o.exp / s).toFixed(2)}</sup>`;
        });

        const substituteMethod = `【次方等比例縮放法】\n把全部次方同除 ${s}（比例不變）：\n原式 ${pack.a}<sup>${A}</sup>·${pack.b}<sup>${B}</sup> → ${pack.a}<sup>${scaledA}</sup>·${pack.b}<sup>${scaledB}</sup> = ${pack.base}<sup>${targetScaled}</sup>。\n再把選項次方同除 ${s} 比較最吻合者。\n${compareLines.join('\n')}`;

        const algebraMethod = `【代數技巧】\n${pack.a}=2<sup>${pack.pa}</sup>，${pack.b}=5<sup>${pack.pb}</sup>。\n原式 = 2<sup>${pack.pa * A}</sup>·5<sup>${pack.pb * B}</sup>。\n依題目構造可合併成 (2·5)<sup>${k}</sup> = ${pack.base}<sup>${k}</sup>。`;

        return { id: i, stem, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod };
      }

      function buildQuestion(i, topic) {
        if (topic === 'quadratic-k') return buildQuadraticKQuestion(i);
        if (topic === 'power-scale') return buildPowerScaleQuestion(i);
        return buildFactorQuestion(i);
      }

      function renderQuiz(topicText) {
        if (!quiz.length) {
          $questions.innerHTML = '<p class="muted">請先按「生成題目」。</p>';
          return;
        }

        $questions.innerHTML = `<p class="muted">目前題型：${topicText}</p>` + quiz.map(q => `
          <div class="q" data-id="${q.id}">
            <h3>${q.id}. ${q.stem}</h3>
            ${q.options.map(opt => `
              <label class="opt">
                <input type="radio" name="q-${q.id}" value="${opt.label}">
                <span class="opt-text">${opt.label}. ${opt.text}</span>
              </label>
            `).join('')}
            <div id="result-${q.id}" class="result hide"></div>
          </div>
        `).join('');
      }

      function generate() {
        let n = parseInt($count.value, 10);
        if (Number.isNaN(n) || n < 1) n = 1;
        if (n > 100) n = 100;
        $count.value = n;

        const topic = $topic.value;
        const topicText = $topic.options[$topic.selectedIndex].text;
        quiz = Array.from({ length: n }, (_, idx) => buildQuestion(idx + 1, topic));

        const modeText = $methodMode.value === 'algebra' ? '代數技巧' : '代入選項法';
        $summary.textContent = `已生成 ${n} 題（${topicText}），解題模式：${modeText}。請作答後按「交卷批改」。`;
        $controlCard.classList.add('collapsed');
        renderQuiz(topicText);
      }

      function grade() {
        if (!quiz.length) {
          alert('請先生成題目');
          return;
        }

        let answered = 0;
        let correct = 0;

        for (const q of quiz) {
          const checked = document.querySelector(`input[name="q-${q.id}"]:checked`);
          const box = document.getElementById(`result-${q.id}`);
          box.classList.remove('hide', 'ok', 'bad');

          if (!checked) {
            box.classList.add('bad');
            box.textContent = `未作答。正確答案：${q.answerLabel}`;
            continue;
          }

          answered++;
          if (checked.value === q.answerLabel) {
            correct++;
            box.classList.add('ok');
            box.textContent = `✅ 正確（答案：${q.answerLabel}）`;
          } else {
            box.classList.add('bad');
            const methodText = $methodMode.value === 'algebra' ? q.algebraMethod : q.substituteMethod;
            box.textContent = `❌ 錯誤，你選 ${checked.value}；正確答案：${q.answerLabel}\n${methodText}`;
          }
        }

        const total = quiz.length;
        const wrong = total - correct;
        $summary.textContent = `完成批改：${correct}/${total} 正確（錯 ${wrong} 題；已作答 ${answered} 題）。`;
      }

      function resetResult() {
        for (const q of quiz) {
          const checked = document.querySelector(`input[name="q-${q.id}"]:checked`);
          if (checked) checked.checked = false;
          const box = document.getElementById(`result-${q.id}`);
          if (box) {
            box.className = 'result hide';
            box.textContent = '';
          }
        }
        if (quiz.length) $summary.textContent = `已清除作答，可重新練習。`;
      }

      function backToStart() {
        $controlCard.classList.remove('collapsed');
        $summary.textContent = '已返回開始版面，可重新選擇題型與設定。';
      }

      $genBtn.addEventListener('click', generate);
      $submitBtn.addEventListener('click', grade);
      $resetBtn.addEventListener('click', resetResult);
      $backBtn.addEventListener('click', backToStart);
    </script>
  </body>
</html>
