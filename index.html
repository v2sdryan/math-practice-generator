<!doctype html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>數學同類題練習產生器</title>
    <style>
      body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; background:#0b1020; color:#e5e7eb; }
      .wrap{ max-width:960px; margin:24px auto; padding:20px; }
      .card{ background:#121933; border:1px solid #243050; border-radius:14px; padding:16px; margin-bottom:14px; }
      h1{ margin:0 0 8px; font-size:28px; }
      .muted{ color:#9ca3af; font-size:14px; }
      .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      @media (max-width: 760px){ .grid{ grid-template-columns:1fr; } }
      input,select,button,textarea{ width:100%; box-sizing:border-box; border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; padding:10px; }
      button{ background:#22c55e; color:#052e16; border:none; font-weight:700; cursor:pointer; }
      button.secondary{ background:#334155; color:#e5e7eb; }
      .row{ display:flex; gap:10px; align-items:center; }
      .row > *{ flex:1; }
      .checks label{ display:block; margin:6px 0; }
      .out{ white-space:pre-wrap; line-height:1.7; font-size:15px; }
      .badge{ display:inline-block; font-size:12px; background:#1e293b; border:1px solid #334155; border-radius:999px; padding:4px 10px; margin-right:6px; }
      img.preview{ width:100%; max-height:240px; object-fit:contain; background:#0f172a; border-radius:10px; border:1px solid #334155; }
    </style>
  </head>
  <body>
    <main class="wrap">
      <h1>數學同類題練習產生器</h1>
      <p class="muted">上傳題目圖片 → 自動估算題型（可手動改）→ 設定題數（1-15）→ 產生練習（題目 / 答案 / 詳解）</p>

      <section class="card grid">
        <div>
          <label>上傳題目圖片</label>
          <input id="imageInput" type="file" accept="image/*" />
          <p class="muted">支援 JPG / PNG。OCR 在你瀏覽器本地執行。</p>
          <img id="preview" class="preview" alt="預覽" style="display:none"/>
        </div>
        <div>
          <label>OCR 文字（可手改）</label>
          <textarea id="ocrText" rows="10" placeholder="OCR 結果會顯示於此..."></textarea>
          <div class="row" style="margin-top:8px;">
            <button id="ocrBtn" class="secondary">從圖片讀字（OCR）</button>
            <button id="detectBtn" class="secondary">判斷題型</button>
          </div>
          <p id="topicHint" class="muted" style="margin-top:8px;">題型：未判斷</p>
        </div>
      </section>

      <section class="card grid">
        <div>
          <label>題型</label>
          <select id="topic">
            <option value="auto">自動判斷</option>
            <option value="indices">指數運算</option>
            <option value="factorization">因式分解 / 恆等式</option>
            <option value="linear">一次方程</option>
            <option value="quadratic">二次方程</option>
            <option value="probability">概率 / 組合</option>
          </select>
        </div>
        <div>
          <label>題數（1-15）</label>
          <input id="count" type="number" min="1" max="15" value="5" />
        </div>
      </section>

      <section class="card checks">
        <label><input type="checkbox" id="showQ" checked /> 只出題目</label>
        <label><input type="checkbox" id="showA" checked /> 顯示答案</label>
        <label><input type="checkbox" id="showS" checked /> 顯示詳解</label>
        <div class="row" style="margin-top:10px;">
          <button id="genBtn">產生練習</button>
          <button id="copyBtn" class="secondary">複製結果</button>
        </div>
      </section>

      <section class="card">
        <div>
          <span class="badge" id="usedTopic">題型：-</span>
          <span class="badge" id="usedCount">題數：-</span>
        </div>
        <div id="output" class="out" style="margin-top:10px;">結果會顯示在這裡。</div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
      const imageInput = document.getElementById('imageInput');
      const preview = document.getElementById('preview');
      const ocrText = document.getElementById('ocrText');
      const topic = document.getElementById('topic');
      const count = document.getElementById('count');
      const output = document.getElementById('output');
      const usedTopic = document.getElementById('usedTopic');
      const usedCount = document.getElementById('usedCount');
      const topicHint = document.getElementById('topicHint');

      let imageDataUrl = '';

      imageInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          imageDataUrl = reader.result;
          preview.src = imageDataUrl;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });

      function detectTopicByText(text) {
        const t = (text || '').toLowerCase();
        if (/\^|x-\d|x\^-|3\^|指數|冪|power|indices/.test(t)) return 'indices';
        if (/因式|factor|\(.*\)\(.*\)|a\^2-b\^2|恆等式/.test(t)) return 'factorization';
        if (/二次|quadratic|x\^2/.test(t)) return 'quadratic';
        if (/概率|probability|組合|permutation|combination/.test(t)) return 'probability';
        return 'linear';
      }

      function topicName(v) {
        return {
          auto:'自動判斷', indices:'指數運算', factorization:'因式分解 / 恆等式',
          linear:'一次方程', quadratic:'二次方程', probability:'概率 / 組合'
        }[v] || v;
      }

      async function runOCR() {
        if (!imageDataUrl) return alert('請先上傳圖片');
        output.textContent = 'OCR 識別中，請稍候...';
        const result = await Tesseract.recognize(imageDataUrl, 'eng+chi_tra');
        ocrText.value = result.data.text || '';
        output.textContent = 'OCR 完成。可按「判斷題型」或直接生成。';
      }

      function detectAndSetTopic() {
        const guess = detectTopicByText(ocrText.value);
        if (topic.value === 'auto') topic.value = guess;
        topicHint.textContent = `題型判斷：${topicName(guess)}`;
        return guess;
      }

      function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

      function genProblem(kind, i){
        if (kind === 'indices') {
          const a = randInt(2,5), b = randInt(2,4), m = randInt(2,5), n = randInt(2,4);
          const q = `(${a}x^${m})^${n} ÷ (${a}x^${b})^2 = ?`;
          const coeffPow = n - 2;
          const xPow = m*n - 2*b;
          const ans = `${a}^${coeffPow}x^${xPow}`;
          const sol = `\n(${a}x^${m})^${n}=${a}^${n}x^${m*n}；(${a}x^${b})^2=${a}^2x^${2*b}\n相除得 ${a}^(${n}-2)x^(${m*n}-${2*b})=${ans}`;
          return { q, ans, sol };
        }
        if (kind === 'factorization') {
          const p = randInt(3,12), qn = randInt(2,9);
          const q = `${p*p} - (${qn}x)^2 因式分解為？`;
          const ans = `(${p}-${qn}x)(${p}+${qn}x)`;
          const sol = `平方差公式 a^2-b^2=(a-b)(a+b)，代 a=${p}, b=${qn}x 即得 ${ans}`;
          return { q, ans, sol };
        }
        if (kind === 'quadratic') {
          const r1 = randInt(1,6), r2 = randInt(1,6);
          const b = -(r1+r2), c = r1*r2;
          const q = `解方程：x^2 ${b>=0?'+':''}${b}x + ${c} = 0`;
          const ans = `x=${r1} 或 x=${r2}`;
          const sol = `找兩數乘積為 ${c}、和為 ${r1+r2}，所以 (x-${r1})(x-${r2})=0，故 ${ans}`;
          return { q, ans, sol };
        }
        if (kind === 'probability') {
          const good = randInt(2,8), bad = randInt(2,8);
          const q = `袋中有 ${good} 粒紅球和 ${bad} 粒藍球，任取一球，抽到紅球的概率為？`;
          const ans = `${good}/${good+bad}`;
          const sol = `概率 = 有利結果 / 全部結果 = ${good}/(${good}+${bad}) = ${ans}`;
          return { q, ans, sol };
        }
        const a = randInt(2,9), b = randInt(1,9), c = randInt(10,40);
        const q = `解方程：${a}x + ${b} = ${c}`;
        const x = (c-b)/a;
        const ans = `x=${x}`;
        const sol = `${a}x=${c}-${b}=${c-b}，所以 x=${c-b}/${a}=${x}`;
        return { q, ans, sol };
      }

      function generate() {
        const showQ = document.getElementById('showQ').checked;
        const showA = document.getElementById('showA').checked;
        const showS = document.getElementById('showS').checked;
        let n = parseInt(count.value || '5', 10);
        if (Number.isNaN(n) || n < 1) n = 1;
        if (n > 15) n = 15;

        const guessed = detectTopicByText(ocrText.value);
        const kind = topic.value === 'auto' ? guessed : topic.value;

        const lines = [];
        lines.push(`【同類練習】題型：${topicName(kind)}；題數：${n}`);
        for (let i=1;i<=n;i++) {
          const p = genProblem(kind, i);
          if (showQ) lines.push(`\n${i}. ${p.q}`);
          if (showA) lines.push(`答案：${p.ans}`);
          if (showS) lines.push(`詳解：${p.sol}`);
        }

        usedTopic.textContent = `題型：${topicName(kind)}`;
        usedCount.textContent = `題數：${n}`;
        output.textContent = lines.join('\n');
      }

      document.getElementById('ocrBtn').addEventListener('click', runOCR);
      document.getElementById('detectBtn').addEventListener('click', detectAndSetTopic);
      document.getElementById('genBtn').addEventListener('click', generate);
      document.getElementById('copyBtn').addEventListener('click', async () => {
        await navigator.clipboard.writeText(output.textContent);
        alert('已複製');
      });
    </script>
  </body>
</html>
